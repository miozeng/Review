# 性能测试与瓶颈分析
通常使用jmeter来对系统进行压力测试，测试出系统哪里容易出现性能瓶颈，再具体分析瓶颈造成的原因，给出优化建议。
一般需要测试：  

响应时间：系统对请求做出响应的时间。例如系统处理一个HTTP请求需要200ms，这个200ms就是系统的响应时间。              
吞吐量：单位时间内处理的请求数量。      
QPS：每秒响应请求数。在互联网领域，这个指标和吞吐量区分的没有这么明显。             
并发用户数：同时承载正常使用系统功能的用户数量。例如一个即时通讯系统，同时在线量一定程度上代表了系统的并发用户数。                 

### 前端性能瓶颈
#### 测试方法：
使用工具：嵌入浏览器的有 yslow 、page speed、httpwatch。独立界面的有 fiddler2、charles 。				
测试各种资源的size，加载速度等。

如下图是yslow 的测试结果	                        	
![image](https://github.com/miozeng/Review/blob/master/%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/yslowtest.png)

#### 优化建议：	
下图是yslow给出的优化建议	  

![image](https://github.com/miozeng/Review/blob/master/%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/yslowadvice.png)
                 
其他意见：                   
1：合并JS和CSS文件减少并发数             		
如果将两个JS文件合并不至于对项目维护造成影响，那么最好将它们合并。                 		

2：使用图片延迟加载技术减少并发数	             	
所谓图片延迟加载，就是每次只加载当前屏幕可见区域的图片，其余的图片在用户滚动页面到该位置后才开始加载。减少了并发数，不但减少了服务器的压力，也降低了页面的加载时间，目前有个Jquery插件Jquery.LazyLoad.js可以实现图片的延迟加载              
		
3.网页HTML 静态化	              			
网页静态化访问效率更高。对于系统读取频繁更新少的数据,可以考虑使用 html 静态化来实现,比如公共配置信息等，这样避免了大量的数据库访问请求；                 
			
### 中间件
如果服务用到了MQ等中间件还要考虑这些中间件的性能。具体的优化根据不同的中间件来			

### 后端服务		
#### 测试方法：						
Jvm分析工具，包括自带的jconsole，jps(进程信息), jstack（查看某个Java进程内的线程堆栈信息）， jmap（查看堆内存使用状况），jstat（JVM统计监测工具）或者使用第三方工具visualvm（单独写一篇jvm工具的）等去查看jvm情况，了解内存使用情况，包括堆栈信息，线程信息等。
		
#### 优化建议：		
1.代码问题	             		
根据实际情况改进代码，包括cpu是否已经使用多核等。               
2.缓冲               
缓冲最常用的场景是提供I/O的速度，jdk不少I/O组件都提供了缓冲的实现，如BuffereWriter.           
3.缓存             
缓存也是常用技术，比如我们常用的EHCahe  Redis等         
4.对象复用--池         
只有对重量级对象使用对象池技术才能提高性能，轻量级的对象反而会降低系统性能           
5.并行替代串行         
6.时间换空间/空间换时间               
根据实际情况选择。                 
7.负载均衡	                        

7.1. 基于DNS的负载均衡--一个域名绑定多个IP		
　　早期的负载均衡解决方案，通过DNS服务中的随机名字解析来实现的，在DNS服务器中，可以为多个不同的地址配置同一个名字，而最终查询这个名字的客户机将在解析这个名字时得到其中的一个地址。因此，对于同一个名字，不同的客户机会得到不同的地址，它们也就访问不同地址上的Web 服务器，从而达到负载均衡的目的。
优点：实现简单、实施容易、成本低、适用于大多数TCP/IP应用；
缺点：不会根据每台服务器的负载情况分配而是平均分配，没有容错机制，无法检测机器故障会继续请求服务。

7.2. 通过硬件四层交换实现负载均衡							
　　在硬件四层交换产品领域，有一些知名的产品，比如Alteon、F5等。但是相对来说价格比较贵，比如之前国网项目就有用的F5，Yahoo中国当初接近2000台服务器使用了三四台Alteon就搞定了
					
7.3. 通过软件四层交换实现负载均衡			
　　软件四层交换我们可以使用Linux上常用的LVS来解决，LVS就是Linux Virtual Server，他提供了基于心跳线heartbeat的实时灾难应对解决方案，提高系统的鲁棒性，同时可供了灵活的虚拟VIP配置和管理功能，可以同时满足多种应用需求，这对于分布式的系统来说必不可少。
一个典型的使用负载均衡的策略就是，在软件或者硬件四层交换的基础上搭建squid集群，这种思路在很多大型网站包括搜索引擎上被采用，这样的架构低成本、高性能还有很强的扩张性。
		
7.4. 通过反向代理服务器实现负载均衡											
　　反向代理服务器减轻了后台 WEB 服务器的负载，提高了访问速度，同时避免了因用户直接与 WEB 服务器通信带来的安全隐患。同时在集群环境下可以实现负载均衡。
反向代理Nginx：http://blog.jobbole.com/94962/					


### 数据库
#### 测试方法：
Smart-slap :              	                 			
特点：全量发压力，可得到最大QPS，对比不同集群的最大QPS。分析不同集群的最大QPS.	           							
Jmeter:	                  		
特点：控制实时压力，分析各集群在指定压力下的性能情况                  	    		

测试以下数据：

系统负载：                 	    
 
CPU:CUP_IDLE 、CPU_WA、SERVER_LOADAVG  

内存：MEM_URATE、MEM_USED	       

网卡：NIC_TOTAL_IN、NIC_TOTAL_OUT、	                                            		
                           
数据库负载：	  

QPS:COM_READS、COM_WEITES  

主从延迟：SECOND_BEHIND_MASTER  

慢查询：SLOW_QUERIES_PT 

连接数：THREADS_CONNECTED、THREADS_RUNNING   


#### 优化建议	
1.数据库配置优化             		
[数据库配置优化](https://github.com/miozeng/Review/blob/master/%E5%A4%A7%E6%95%B0%E6%8D%AE%E4%B8%8E%E9%AB%98%E5%B9%B6%E5%8F%91%E4%B8%8Emysql%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/MYSQL%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BC%98%E5%8C%96.md)


2.数据库sql优化              		
一条好的sql可以提高整个执行速度                   		
[数据库sql优化](https://github.com/miozeng/Review/blob/master/%E5%A4%A7%E6%95%B0%E6%8D%AE%E4%B8%8E%E9%AB%98%E5%B9%B6%E5%8F%91%E4%B8%8Emysql%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/sql%E4%BC%98%E5%8C%96.md)

3.数据库集群和库表散列 				          
当一台数据无法满足要求时，集群成了最好的选择，集群方面每种数据库都要自己的方案常用的 MySQL 提供的 Master/Slave，除此之外良好的分库分表也可以提升数据库的整体读写能力。

读写分离，通过从库的水平扩展可以解决读压力，			

垂直分库，通过按业务拆分主库可以缓解写压力，	

当业务不能再垂直分库的时候，水平分库就可以解决此问题	            				
[数据库水平切割](https://github.com/miozeng/Review/blob/master/%E5%A4%A7%E6%95%B0%E6%8D%AE%E4%B8%8E%E9%AB%98%E5%B9%B6%E5%8F%91%E4%B8%8Emysql%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%B0%B4%E5%B9%B3%E5%88%87%E5%89%B2.md)

4.缓存	 
对于大量的查询等操作最先想到的就是缓存，目前除了以前的二级查询，常用的还有redis和mongodb等nosql去做缓存。能大大提高系统效率减少数据库的访问等。           


### 硬件
#### 测试工具方法：
Lunix 用top命令，windows查看任务管理器			
a. cpu 是否长时间超过85%

b. 服务器RAM是否用完	

c. 磁盘空间是否不足						
检查磁盘子系统，在Lunix 使用工具vmstat，在Windows 下使用性能监测器，如果可用磁盘不能满足需求，同时又有大量空闲内存剩余，那么这就是一个I/O问题。可能的原因包括，记录了大量的冗余日志，对数据库不恰当的配置使得在磁盘上创建了许多临时表，后台脚本的执行，对于一个需要大量写操作的系统使用了一个不恰当的RAID级别，等等
					
d. 网络是否持续丢包网络宽带是否用完				
   如果网络带宽用完了，那么只有两种解决方案。一个是增加带宽。另一个是对发送的信息进行恰当的压缩，从而发送更少的信息。								

关于cpu，内存，磁盘空间不足等问题如果显示占用的主要进程是web服务或者数据库，就要对web服务或者数据库进行优			







 

