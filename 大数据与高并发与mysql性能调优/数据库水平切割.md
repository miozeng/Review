# 数据库水平切割
原文https://mp.weixin.qq.com/s/8aI9jS0SXJl5NdcM3TPYuQ
### 单KEY水平切割
用例：用户中心
用户中心是一个非常常见的业务，主要提供用户注册、登录、信息查询与修改的服务

水平切割方法
当数据量越来越大时，需要对数据库进行水平切分，常见的水平切分算法有“范围法”和“哈希法”。
范围法，以用户中心的业务主键uid为划分依据，将数据水平切分到两个数据库实例上去
user-db1：存储0到1千万的uid数据
user-db2：存储1到2千万的uid数据

范围法的优点是：
切分策略简单，根据uid，按照范围，user- center很快能够定位到数据在哪个库上
扩容简单，如果容量不够，只要增加user-db3即可

范围法的不足是：
uid必须要满足递增的特性
数据量不均，新增的user-db3，在初期的数据会比较少
请求量不均，一般来说，新注册的用户活跃度会比较高，故user-db2往往会比user-db1负载要高，导致服务器利用率不平衡


哈希法，也是以用户中心的业务主键uid为划分依据，将数据水平切分到两个数据库实例上去：

user-db1：存储uid取模得1的uid数据
user-db2：存储uid取模得0的uid数据
 
哈希法的优点是：
切分策略简单，根据uid，按照hash，user-center很快能够定位到数据在哪个库上
数据量均衡，只要uid是均匀的，数据在各个库上的分布一定是均衡的
请求量均衡，只要uid是均匀的，负载在各个库上的分布一定是均衡的

哈希法的不足是：
扩容麻烦，如果容量不够，要增加一个库，重新hash可能会导致数据迁移，如何平滑的进行数据迁移，是一个需要解决的问题



常见问题
对于uid属性上的查询可以直接路由到库，对于非uid属性上的查询，例如login_name属性上的查询，就悲剧了，假设访问login_name=shenjian的数据，由于不知道数据落在哪个库上，往往需要遍历所有库，当分库数量多起来，性能会显著降低。


典型问题的优化思路

针对用户侧，：用户登录：通过login_name/phone/email查询用户的实体，1%请求属于这种类型
用户信息查询：登录之后，通过uid来查询用户的实例，99%请求属这种类型

应该采用“建立非uid属性到uid的映射关系”的架构方案
最佳时间【索引表法】
思路：uid能直接定位到库，login_name不能直接定位到库，如果通过login_name能查询到uid，问题解决

解决方案：
建立一个索引表记录login_name->uid的映射关系
用login_name来访问时，先通过索引表查询到uid，再定位相应的库
索引表属性较少，可以容纳非常多数据，一般不需要分库
如果数据量过大，可以通过login_name来分库

潜在不足：多一次数据库查询，性能下降一倍
 
【缓存映射法】
思路：访问索引表性能较低，把映射关系放在缓存里性能更佳

解决方案：
login_name查询先到cache中查询uid，再根据uid定位数据库
假设cache miss，采用扫全库法获取login_name对应的uid，放入cache
login_name到uid的映射关系不会变化，映射关系一旦放入缓存，不会更改，无需淘汰，缓存命中率超高
如果数据量过大，可以通过login_name进行cache水平切分

潜在不足：多一次cache查询
 
【login_name生成uid】
思路：不进行远程查询，由login_name直接得到uid

解决方案：
在用户注册时，设计函数login_name生成uid，uid=f(login_name)，按uid分库插入数据
用login_name来访问时，先通过函数计算出uid，即uid=f(login_name)再来一遍，由uid路由到对应库

潜在不足：该函数设计需要非常讲究技巧，有uid生成冲突风险
 
【login_name基因融入uid】
思路：不能用login_name生成uid，可以从login_name抽取“基因”，融入uid中



针对运营侧（根据产品、运营需求，访问模式各异，按照年龄、性别、头像、登陆时间、注册时间来进行查询。
），应该采用“前台与后台分离”的架构方案
前台、后台系统web/service/db分离解耦，避免后台低效查询引发前台查询抖动
可以采用数据冗余的设计方式
可以采用“外置索引”（例如ES搜索系统）或者“大数据处理”（例如HIVE）来满足后台变态的查询需求

1对多业务--帖子
https://mp.weixin.qq.com/s/kOTz5XAeAcUI2gzKl7AEHw

多对多业务--粉丝关注
https://mp.weixin.qq.com/s/uir4eoHO3wJTdg82k658Lg
